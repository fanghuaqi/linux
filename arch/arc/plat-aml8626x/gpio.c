/*
Linux gpio.C

*/
#include <linux/module.h>
#include <plat/am_regs.h>
#include <plat/gpio.h>
#include <plat/pinmux.h>

struct gpio_addr
{
	unsigned long mode_addr;
	unsigned long out_addr;
	unsigned long in_addr;
};
static struct gpio_addr gpio_addrs[]=
{
	[PREG_EGPIO]={PREG_EGPIO_EN_N,PREG_EGPIO_O,PREG_EGPIO_I},
	[PREG_FGPIO]={PREG_FGPIO_EN_N,PREG_FGPIO_O,PREG_FGPIO_I},
	[PREG_GGPIO]={PREG_GGPIO_EN_N,PREG_GGPIO_O,PREG_GGPIO_I},
	[PREG_HGPIO]={PREG_HGPIO_EN_N,PREG_HGPIO_O,PREG_HGPIO_I},
	[PREG_JTAG_GPIO]={PREG_JTAG_GPIO_ADDR,PREG_JTAG_GPIO_ADDR,PREG_JTAG_GPIO_ADDR},
};
//pin mux settings. read a3-core-pin-mux.xlsx
static u32	 save_pin_multi_func_tab[MAX_GROUP_INDEX][13];
static const u32  pin_multi_func_mask_tab[MAX_GROUP_INDEX][13]={
	/*pin	mux: reg0	reg1     	reg2		reg3		reg4		reg5		reg6		reg7		reg8		reg9		reg10	reg11	reg12*/
	[GPIOA_0]=	{0x1,	0x00,	0x00,	0x00	,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_1]=	{0x2,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x2a,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_2]=	{0x4,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x15,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_3]=	{0x18,	(1<<31),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_4]=	{(0x2a<<4),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x28,	(1<<13),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_5]=	{(0x54<<4),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	(0x14<<4),(1<<12),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_6]=	{(1<<20)|(1<<12),	(1<<9),	0x00	,0x00,0x00,	0x00	,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_7]=	{(1<<22)|(1<<13),	(1<<8),	0x00	,0x00,0x00,	0x00	,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_8]=	{(1<<22)|(1<<14),	(1<<7),	0x00	,0x00,0x00,	0x00	,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_9]=	{(1<<23)|(1<<15),	(1<<6),	0x00	,0x00,0x00,	0x00	,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_10]=	{(1<<24)|(1<<16),	(1<<5),	0x00	,0x00,0x00,	0x00	,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_11]=	{(1<<25)|(1<<17),	0x1c,(1<<7),0x00	,0x00,	0x00	,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_12]=	{(1<<27)|(1<<26)|(1<<18),	0x00,0x00	,0x00,0x00,(1<<28),	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_13]=	{(1<<29)|(1<<28)|(1<<19),	0x00,0x00	,0x00,0x00,0x00,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_14]=	{(1<<11),(1<<17)|(1<<13)|0x03,0x00	,0x00,0x00,0x00,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_15]=	{(1<<11),(1<<16)|(1<<12)|0x03,0x00	,0x00,0x00,0x00,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_16]=	{(1<<11),(1<<15)|(1<<11)|0x03,0x00	,0x00,0x00,0x00,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOA_17]=	{(1<<11),(1<<14)|(1<<10)|0x03,0x00	,0x00,0x00,0x00,	0x00	,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	/*pin	mux: reg0	reg1     	reg2		reg3		reg4		reg5		reg6		reg7		reg8		reg9		reg10	reg11	reg12*/
	[GPIOB_0]=	{0x00,(1<<29)|(1<<18),(1<<5),0x00,0x00,0x00,(1<<17)|(1<<13)|(1<<11),0x00,0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOB_1]=	{0x00,(1<<27)|(1<<18),(1<<4),0x00,0x00,0x00,(1<<16)|(1<<12)|(1<<10),0x00,0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOB_2]=	{0x00,(1<<26)|(1<<18),(1<<3),0x00,	0x00,	0x00,	(1<<15),	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOB_3]=	{0x00,(1<<28)|(1<<18),(1<<2),0x00,	0x00,	0x00,	(1<<14),	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOB_4]=	{0x00,(1<<25)|(1<<22),(1<<1),(1<<25),0x00,	0x00,	(1<<18),	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOB_5]=	{0x00,	(1<<21),	(1<<0),	(1<<24),	0x00,	0x00,	(1<<19),	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOB_6]=	{0x00,(0x11<<20),	0x00	,	0x00,	0x00,	0x00,	(0xa9<<20),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOB_7]=	{0x00,(1<<19),	(1<<6),	0x00,	0x00,	0x00,	(0x2b<<21),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	/*pin	mux: reg0	reg1     	reg2		reg3		reg4		reg5		reg6		reg7		reg8		reg9		reg10	reg11	reg12*/
	[GPIOC_0]=	{0x0,	0x00,	(0x61<<24),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_1]=	{0x0,	0x00,(1<<28)|(1<<24),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_2]=	{0x00,	0x00,(1<<27)|(0x83<<17),0x00,0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_3]=	{0x00,	0x00,(5<<24)|(1<<16),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_4]=	{0x00,	0x00,(3<<24)|(1<<15),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_5]=	{0x00,	0x00,(3<<24)|(1<<14),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_6]=	{0x00,	0x00,(3<<24)|(1<<13),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_7]=	{0x00,	0x00,(5<<23)|(1<<12),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_8]=	{0x00,	0x00,(9<<22)|(1<<11),0x00,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_9]=	{0x00,	0x00,(0x11<<21)|(1<<10),0x00,0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_10]=	{0x00,	0x00,(0x21<<20)|(1<<9),0x00,0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_11]=	{0x00,	0x00,(0x41<<19)|(1<<8),0x00,0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_12]=	{0x00,	0x00,	0x00,(1<<11)|(1<<5),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_13]=	{0x00,	0x00,	0x00,(1<<11)|(1<<5),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_14]=	{0x00,	0x00,	0x00,(3<<10)|(1<<5),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_15]=	{0x00,	0x00,	0x00,(5<<9)|(1<<5),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_16]=	{0x00,	0x00,	0x00,(9<<8)|(1<<5),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_17]=	{0x00,	0x00,	0x00,(0x11<<7)|(1<<5),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_18]=	{0x00,	0x00,	0x00,(1<<12)|(3<<5),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_19]=	{0x00,	0x00,	0x00,(1<<12)|(1<<4),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_20]=	{0x00,	0x00,	0x00,(1<<13)|(1<<3),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_21]=	{0x00,	0x00,	0x00,(1<<13)|(1<<2),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_22]=	{0x00,	0x00,	0x00,(1<<13)|(1<<1),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOC_23]=	{0x00,	0x00,	0x00,(1<<13)|(1<<0),0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	/*pin	mux: reg0	reg1     	reg2		reg3		reg4		reg5		reg6		reg7		reg8		reg9		reg10	reg11	reg12*/
	[GPIOD_0]=	{0x00,	0x00,	0x00,(0x11<<13),	(1<<10),	0x00,	0x00	,	(1<<5),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_1]=	{0x00,	0x00,	0x00,(0x21<<13),	(1<<9),	0x00,	0x00	,	(1<<4),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_2]=	{0x00,	0x00,	0x00,(0x21<<14),	(1<<8),	0x00,	0x00	,	(1<<3),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_3]=	{0x00,	0x00,	0x00,(0x41<<14),	(1<<7),	0x00,	0x00	,	(1<<2),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_4]=	{0x00,	0x00,	0x00,(0x41<<15),	(1<<6),	0x00,	0x00	,	(1<<1),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_5]=	{0x00,	0x00,	0x00,(0x81<<15),	(1<<5),	0x00,	0x00	,	(1<<0),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_6]=	{0x00,	0x00,	0x00,(0x81<<15),	(1<<4),	0x00,	0x00	,	(1<<0),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_7]=	{0x00,	0x00,	0x00,(0x81<<15),	(1<<3),	0x00,	0x00	,	(1<<0),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_8]=	{0x00,	0x00,	0x00,(0x81<<15),	(1<<2),	0x00,	0x00	,	(1<<0),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_9]=	{0x00,	0x00,	0x00,(0x81<<15),	(3<<0),	0x00,	0x00	,	(1<<0),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_10]=	{0x00,	0x00,	0x00,(0x41<<16),	0x00,	0x00,	0x00	,	(1<<0),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOD_11]=	{0x00,	0x00,	0x00,(0xc1<<16),	0x00,	0x00,	0x00	,	(1<<0),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	/*pin	mux: reg0	reg1     	reg2		reg3		reg4		reg5		reg6		reg7		reg8		reg9		reg10	reg11	reg12*/
	[GPIOE_0]=	{0x00,	0x00,	0x00,	0x00	,	(1<<19),	(1<<4),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_1]=	{0x00,	0x00,	0x00,	0x00	,	(1<<18),	(0x41<<3),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_2]=	{0x00,	0x00,	0x00,	0x00	,	(1<<17),	(0x41<<2),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_3]=	{0x00,	0x00,	0x00,	0x00	,	(1<<16),	(0x41<<1),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_4]=	{0x00,	0x00,	0x00,	0x00	,	(1<<15),	0x00,	(1<<28),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_5]=	{0x00,	0x00,	0x00,	0x00	,	(1<<14),	(0x61<<0),0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_6]=	{0x00,	0x00,	0x00,	0x00	,	(1<<13)|(1<<21),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_7]=	{0x00,	0x00,	0x00,	0x00	,	(1<<12)|(1<<20),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_8]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11)|(1<<27),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_9]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11)|(1<<26),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_10]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11)|(1<<25),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_11]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11)|(1<<24),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_12]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11)|(1<<23),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_13]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11)|(1<<22),0x00,0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_14]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11),	0x00,	0x00,	(1<<7),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOE_15]=	{0x00,	0x00,	0x00,	0x00	,	(1<<11),	0x00,	0x00,	(1<<6),	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	/*pin	mux: reg0	reg1     	reg2		reg3		reg4		reg5		reg6		reg7		reg8		reg9		reg10	reg11	reg12*/
	[GPIOF_0]=	{0x00,	0x00,	0x00,	0x00	,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_1]=	{0x00,	0x00,	0x00,	0x00	,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_2]=	{0x00,	0x00,	0x00,	0x00	,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_3]=	{0x00,	0x00,	0x00,	0x00	,	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_4]=	{0x00,	0x00,	0x00,	(1<<31),	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_5]=	{0x00,	0x00,	0x00,	(1<<30),	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_6]=	{0x00,	0x00,	0x00,	(1<<29),	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_7]=	{0x00,	0x00,	0x00,	(1<<28),	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_8]=	{0x00,	0x00,	0x00,	(1<<27),	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	[GPIOF_9]=	{0x00,	0x00,	0x00,	(1<<26),	0x00,	0x00,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	,	0x00	},
	
};
char jtag_bits_map[][3] =
{
	[0]={0, 4, 8},
	[1]={1, 5, 9},
	[2]={2, 6, 10},
	[3]={3, 7, 11},
	[16]={16, 20, 24},
};

static inline int gpio_bits(int type, gpio_bank_t bank,int bit)
{
	if ((bank == PREG_JTAG_GPIO)&&(type<3)) {
		return jtag_bits_map[bit][type];
	}
	else {
		return bit;
	}
}

int	control_gpio_function(u32  group_index,u32  io_enable)
{
	int i;
	u32 reg=PERIPHS_PIN_MUX_0;
	u32 mask;

	if(group_index >=MAX_GROUP_INDEX) return -1;
	if (io_enable)
	{
		for(i=0;i<13;i++)
		{
			mask=pin_multi_func_mask_tab[group_index][i];
			if(mask)
			{
				save_pin_multi_func_tab[group_index][i]=READ_MPEG_REG(reg)&mask;
				clear_mio_mux(i,mask);
				printk("group_idx:%d   mask:0x%x mux:%d\n",group_index,mask,i);
			}	
			reg++;
		}
	}
	else
	{
		for(i=0;i<13;i++)
		{
			mask=pin_multi_func_mask_tab[group_index][i];
			if(mask)
			{
				if(READ_MPEG_REG(reg)&mask) /*if function bit has been set ,reserve it & return */
				return -1;	
			}	
			reg++;
		}
		for(i=0;i<13;i++)
		{
			mask=pin_multi_func_mask_tab[group_index][i];
			if(mask)
			{
				mask&=save_pin_multi_func_tab[group_index][i];
				set_mio_mux(i, mask); //restore origin mutl function bit.
				printk("group_idx:%d   mask:0x%x mux:%d\n",group_index,mask,i);
			}	
			reg++;
		}
	}
	return 0;
}
int set_gpio_mode(gpio_bank_t bank,int bit,gpio_mode_t mode)
{
#ifdef CONFIG_EXGPIO
	if (bank >= EXGPIO_BANK0) {
		set_exgpio_mode(bank - EXGPIO_BANK0, bit, mode);
		return 0;
	}
#endif
	unsigned long addr=gpio_addrs[bank].mode_addr;
	WRITE_CBUS_REG_BITS(addr,mode,gpio_bits(0, bank, bit),1);
	return 0;
}

gpio_mode_t get_gpio_mode(gpio_bank_t bank,int bit)
{
#ifdef CONFIG_EXGPIO
	if (bank >= EXGPIO_BANK0) {
		return get_exgpio_mode(bank - EXGPIO_BANK0, bit);
	}
#endif
	unsigned long addr=gpio_addrs[bank].mode_addr;
	return (READ_CBUS_REG_BITS(addr,gpio_bits(0, bank, bit),1)>0)?(GPIO_INPUT_MODE):(GPIO_OUTPUT_MODE);
}


int set_gpio_val(gpio_bank_t bank,int bit,unsigned long val)
{
#ifdef CONFIG_EXGPIO
	if (bank >= EXGPIO_BANK0) {
		set_exgpio_val(bank - EXGPIO_BANK0, bit, val);
		return 0;
	}
#endif
	unsigned long addr=gpio_addrs[bank].out_addr;
	WRITE_CBUS_REG_BITS(addr,val?1:0,gpio_bits(1, bank, bit),1);

	return 0;
}

unsigned long  get_gpio_val(gpio_bank_t bank,int bit)
{
#ifdef CONFIG_EXGPIO
	if (bank >= EXGPIO_BANK0) {
		return get_exgpio_val(bank - EXGPIO_BANK0, bit);
	}
#endif
	unsigned long addr=gpio_addrs[bank].in_addr;
	return READ_CBUS_REG_BITS(addr,gpio_bits(2, bank, bit),1);
}

int gpio_to_idx(unsigned gpio)
{
    gpio_bank_t bank = (gpio_bank_t)(gpio >> 16);
    int bit = gpio & 0xFFFF;
    int idx = -1;
//    
//    if (bank == PREG_EGPIO) {
//        if (bit < 4) idx = GPIOA_23_IDX - bit;
//        else if (bit < 19) idx = GPIOA_IDX + bit - 4;
//        else idx = GPIOB_IDX + bit - 19;
//    }
//     else if (bank == PREG_FGPIO)
//        idx = GPIOC_IDX + bit;
//     else if (bank == PREG_GGPIO)
//        idx = GPIOD_IDX + bit + 2;
//     else if (bank == PREG_HGPIO)
//        idx = GPIOE_IDX + bit;
    return 0;//idx;
}

/**
 * enable gpio edge interrupt
 *	
 * @param [in] pin  index number of the chip, start with 0 up to 255 
 * @param [in] flag rising(0) or falling(1) edge 
 * @param [in] group  this interrupt belong to which interrupt group  from 0 to 7
 */
void gpio_enable_edge_int(int pin , int flag, int group)
{
	unsigned ireg;

	group &= 7;
	ireg = GPIO_INTR_GPIO_SEL0 + (group>>2);
	SET_CBUS_REG_MASK(ireg, pin<<((group&3)<<3));
	SET_CBUS_REG_MASK(GPIO_INTR_EDGE_POL, ((flag<<(16+group)) | (1<<group)));	
//	WRITE_CBUS_REG_BITS(A9_0_IRQ_IN2_INTR_STAT_CLR, 0, group, 1);
}
/**
 * enable gpio level interrupt
 *	
 * @param [in] pin  index number of the chip, start with 0 up to 255 
 * @param [in] flag high(0) or low(1) level 
 * @param [in] group  this interrupt belong to which interrupt group  from 0 to 7
 */
void gpio_enable_level_int(int pin , int flag, int group)
{	
	unsigned ireg;

	group &= 7;
	ireg = GPIO_INTR_GPIO_SEL0 + (group>>2);
	SET_CBUS_REG_MASK(ireg, pin<<((group&3)<<3));
	SET_CBUS_REG_MASK(GPIO_INTR_EDGE_POL, ((flag<<(16+group)) | (0<<group)));	
//	WRITE_CBUS_REG_BITS(A9_0_IRQ_IN2_INTR_STAT_CLR, 0, group, 1);
}

/**
 * enable gpio interrupt filter
 *
 * @param [in] filter from 0~7(*222ns)
 * @param [in] group  this interrupt belong to which interrupt group  from 0 to 7
 */
void gpio_enable_int_filter(int filter, int group)
{	
	unsigned ireg;

	group &= 7;
	 ireg = GPIO_INTR_FILTER_SEL0;
	SET_CBUS_REG_MASK(ireg, filter<<(group<<2));
}

int gpio_is_valid(int number)
{
	return 1;
}

int gpio_request(unsigned gpio, const char *label)
{
	return 0;
}

void gpio_free(unsigned gpio)
{
}

int gpio_direction_input(unsigned gpio)
{
	gpio_bank_t bank = (gpio_bank_t)(gpio >> 16);
	int bit = gpio & 0xFFFF;
	set_gpio_mode(bank, bit, GPIO_INPUT_MODE);
	printk( "set gpio%d.%d input\n", bank, bit);
	return 0;
}
EXPORT_SYMBOL(gpio_direction_input);

int gpio_direction_output(unsigned gpio, int value)
{
	gpio_bank_t bank = (gpio_bank_t)(gpio >> 16);
	int bit = gpio & 0xFFFF;
	set_gpio_val(bank, bit, value?1:0);
	set_gpio_mode(bank, bit, GPIO_OUTPUT_MODE);
	printk( "set gpio%d.%d output\n", bank, bit);
	return 0;
}
EXPORT_SYMBOL(gpio_direction_output);

void gpio_set_value(unsigned gpio, int value)
{
	gpio_bank_t bank = (gpio_bank_t)(gpio >> 16);
	int bit = gpio & 0xFFFF;
	set_gpio_val(bank, bit, value?1:0);
}
EXPORT_SYMBOL(gpio_set_value);

int gpio_get_value(unsigned gpio)
{
	gpio_bank_t bank = (gpio_bank_t)(gpio >> 16);
	int bit = gpio & 0xFFFF;
	return (get_gpio_val(bank, bit));
}
EXPORT_SYMBOL(gpio_get_value);

